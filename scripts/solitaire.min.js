function newGame(){cardDivs.forEach(e=>e.parentNode.removeChild(e)),bayDivs.forEach(e=>e.dataset.ord=0),clearCkie("SolHist"),document.querySelector("h1").style.display="none",document.querySelector("#winBtn").style.display="none",Hist=[];let e=shuffle(52),t=new Array(52);for(let s=0;s<52;s++)t[s]={},t[s].container="stockPile",t[s].selected=!1,t[s].value=CARD_VALUES[e[s]%13+1],t[s].suit=CARD_SUITS[Math.floor(e[s]/13)],t[s].colour=SUIT_VALUE_MAP[t[s].suit];let s={cards:[]};s.cards=t,writeCkie("SolDeck",JSON.stringify(s));let l={};for(let e=1;e<8;e++)for(let t=0;t<e;t++)l=s.cards.shift(),l.container=`stack${e}`,createCard(`stack${e}Div`,l),t==e-1&&document.querySelector(`#stack${e}Div`).lastChild.classList.remove("closed");for(let e=0;e<s.cards.length;e++)s.cards[e].colour=SUIT_VALUE_MAP[s.cards[e].suit],createCard("stockPileDiv",s.cards[e]);AddCardHandlers()}async function rldGame(){cardDivs.forEach(e=>e.parentNode.removeChild(e)),bayDivs.forEach(e=>e.dataset.ord=0),document.querySelector("h1").style.display="none",document.querySelector("#winBtn").style.display="none";let e=JSON.parse(readCkie("SolDeck"));if(null===e)return e=[],alert("No previous game stored."),!1;let t={};for(let s=1;s<8;s++)for(let l=0;l<s;l++)t=e.cards.shift(),t.container=`stack${s}`,createCard(`stack${s}Div`,t),l==s-1&&document.querySelector(`#stack${s}Div`).lastChild.classList.remove("closed");for(let t=0;t<e.cards.length;t++)createCard("stockPileDiv",e.cards[t]);if(AddCardHandlers(),Hist=JSON.parse(readCkie("SolHist")),null!=Hist){console.log("reload game:"+Hist.length);let e=Hist.length;for(let t=0;t<e;t++){let e=document.querySelector("#"+Hist[t].fromCntr).childElementCount+1-Hist[t].numCrds;document.querySelectorAll(".sel").forEach(e=>e.classList.remove("sel")),"stockPileDiv"==Hist[t].fromCntr?document.querySelector("#"+Hist[t].fromCntr).click():"openPileDiv"==Hist[t].fromCntr?(await sleep(200),document.querySelector("#"+Hist[t].fromCntr).lastChild.click()):(await sleep(200),document.querySelector("#"+Hist[t].fromCntr).childNodes[e].click()),document.querySelector("#"+Hist[t].toCntr).childElementCount>0?document.querySelector("#"+Hist[t].toCntr).lastChild.click():document.querySelector("#"+Hist[t].toCntr).click()}}Hist=JSON.parse(readCkie("SolHist")),null==Hist&&(Hist=[],console.log("Hist = [], after reload")),console.log("reload successful; history length:"+Hist.length)}function AddCardHandlers(){cardDivs=document.querySelectorAll(".card"),cardDivs.forEach(e=>{e.addEventListener("dragstart",dragStart)}),cardDivs.forEach(e=>{e.addEventListener("dragover",allowDrop)}),cardDivs.forEach(e=>{e.addEventListener("drop",drop)}),cardDivs.forEach(e=>{e.addEventListener("click",()=>{const t=document.querySelectorAll(".sel");e.classList.contains("closed")||e.parentNode.classList.contains("bay")||(e.classList.contains("sel")?t.forEach(e=>e.classList.remove("sel")):t&&0==t.length?(e.classList.add("sel"),selSibsBelow(e),Coords.top=Math.round(e.getBoundingClientRect().top),Coords.left=Math.round(e.getBoundingClientRect().left)):"openPileDiv"!=e.parentNode.id&&t[0].dataset.colour!=e.dataset.colour&&parseInt(t[0].dataset.ord)==parseInt(e.dataset.ord)-1?moveCards(t,e.parentNode):t.forEach(e=>e.classList.remove("sel")))})}),cardDivs.forEach(e=>{e.addEventListener("dblclick",()=>{bayDivs.forEach(t=>{if(e.dataset.suit==t.dataset.suit&&parseInt(e.dataset.ord)==parseInt(t.dataset.ord)+1){t.dataset.ord=e.dataset.ord,e.classList.add("sel");const s=[];s.push(e),moveCards(s,t),t.lastChild.setAttribute("draggable",!1)}})})})}function createCard(e,t){let s=document.querySelector("#"+e),l=document.createElement("div");l.classList.add("card",t.colour,"closed"),l.innerHTML=`${t.value}<br />${t.suit}<span>${t.value}<br />${t.suit}</span>`,l.dataset.value=`${t.suit}${t.value}`,l.dataset.suit=t.suit,l.dataset.colour=t.colour,l.dataset.ord=CARD_VALUE_MAP[t.value],l.setAttribute("draggable",!0),s.appendChild(l)}function moveCards(e,t){const s=e[0].parentNode.querySelectorAll(".card:not(.sel)");let l=!1;if(s&&s.length>0){let e=s[s.length-1];l=e.classList.contains("closed"),e.classList.remove("closed")}let r=new Move(e,t.id,l);Hist.push(r);let o=0,a=0;e.forEach(e=>{t.appendChild(e),e.classList.remove("sel"),o=e.getBoundingClientRect().left-Coords.left,a=e.getBoundingClientRect().top-Coords.top,e.classList.add("anim"),e.style.left=-o+"px",e.style.top=-a+"px",e.style.cssText+=`transition: transform 0.5s ease; transform: translate(${o}px, ${a}px);`,setTimeout(()=>{e.style.cssText="",e.classList.remove("anim")},[500])}),winCond()&&"block"!=document.querySelector("h1").style.display&&(document.querySelector("h1").style.display="block",document.querySelector("#winBtn").style.display="block",window.scrollTo(0,0))}function winCond(){let e=0;return stackDivs.forEach(t=>{t.childElementCount>0&&(selSibsBelow(t.querySelectorAll(".card")[0]),e+=document.querySelectorAll(".closed").length,t.querySelectorAll(".card").forEach(e=>e.classList.remove("sel")))}),!e}function selSibsBelow(e){const t=e.parentNode.querySelectorAll(".card:not(.closed)");for(let e=0;e<t.length;e++)if(t[e].classList.contains("sel")){for(let s=e;s<t.length;s++)t[s].classList.add("sel");break}}function Move(e,t,s){this.fromCntr=e[0].parentNode.id,this.numCrds=e.length,this.toCntr=t,this.flip=s}async function winSequence(e){let t=1,s=0,l=.5,r=2*Math.floor(3*Math.random())+2,o=r,a=1,i=e=>.5*e*e,n=Math.floor(50*Math.random())-30,c=-i(n);Dir*=-1;const d=e.parentNode.getBoundingClientRect().right,u=window.innerWidth-e.parentNode.getBoundingClientRect().right,h=window.innerHeight-e.parentNode.getBoundingClientRect().bottom;for(var m=function(t,s){return new Promise(function(a,n){const d=e.cloneNode(!0);d.classList.add("anim"),d.style.zIndex=Zndx,e.parentNode.appendChild(d),l=i(s)+c,o=r*t,d.style.top=l+"px",d.style.left=Dir*o+"px",a(o,l)})};l<h&&(Dir<0&&o<d||Dir>0&&o<u);){for(s=n;l<h&&(Dir<0&&o<d||Dir>0&&o<u);)m(t,s).then(await sleep(3)),t++,s++;c+=.1*l,a=parseInt(.9*(s-1)),c=l-.5*a*a;for(let e=a;e>-n;e--)m(t,e).then(await sleep(3)),t++}Zndx++}function allowDrop(e){e.preventDefault()}function dragStart(e){cardDivs.forEach(e=>e.classList.remove("sel")),e.target.classList.add("sel"),e.target.parentNode.classList.contains("stack")&&selSibsBelow(e.target)}function drop(e){e.preventDefault(),e.target.click(),cardDivs.forEach(e=>e.classList.remove("sel"))}import{readCkie,writeCkie,clearCkie,sleep,shuffle}from"./utils.min.js";const stockPileDiv=document.querySelector("#stockPileDiv"),openPileDiv=document.querySelector("#openPileDiv"),stackDivs=document.querySelectorAll(".stack"),bayDivs=document.querySelectorAll(".bay"),CARD_VALUE_MAP={0:0,A:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,J:11,Q:12,K:13},CARD_VALUES=["0","A","2","3","4","5","6","7","8","9","10","J","Q","K"],CARD_SUITS=["♠","♥","♦","♣"],SUIT_VALUE_MAP={"♠":"black","♣":"black","♥":"red","♦":"red"};var Hist=[],cardDivs=[],Coords={top:0,left:0},Dir=1,Zndx=1;document.querySelector("#winBtn").addEventListener("click",async function(){this.disabled=!0,document.querySelectorAll(".card.anim").forEach(e=>e.remove());let e=document.querySelectorAll("#bay♠Div .card:not(.anim), #bay♦Div .card:not(.anim)"),t=shuffle(e.length),s=e.length<6?e.length:6;for(let l=0;l<s;l++)await winSequence(e[t[l]]);e=document.querySelectorAll("#bay♥Div .card:not(.anim), #bay♣Div .card:not(.anim)"),t=shuffle(e.length),s=e.length<6?e.length:6;for(let l=0;l<s;l++)await winSequence(e[t[l]]);document.querySelectorAll(".anim").forEach(e=>e.classList.add("turn")),this.disabled=!1}),document.querySelector("#newBtn").addEventListener("click",function(){document.querySelectorAll(".card.anim").forEach(e=>e.remove()),newGame()}),document.querySelector("#rldBtn").addEventListener("click",function(){document.querySelectorAll(".card.anim").forEach(e=>e.remove()),rldGame()}),document.querySelector("#sveBtn").addEventListener("click",function(){document.querySelectorAll(".card.anim").forEach(e=>e.remove()),console.log("history length:"+Hist.length),0==Hist.length?alert("Cannot save any progress. Try reloading game first."):writeCkie("SolHist",JSON.stringify(Hist))}),document.getElementById("undoBtn").addEventListener("click",function(){if(document.querySelectorAll(".card.anim").forEach(e=>e.remove()),Hist&&Hist.length>0){const e=document.querySelector("#"+Hist[Hist.length-1].fromCntr),t=document.querySelector("#"+Hist[Hist.length-1].toCntr),s=t.childNodes.length-Hist[Hist.length-1].numCrds;if(Hist[Hist.length-1].flip&&e.lastChild.classList.add("closed"),"stockPileDiv"==t.id)for(let s=0;s<Hist[Hist.length-1].numCrds;s++)e.appendChild(t.lastChild),e.lastChild.classList.remove("closed");else{for(let l=0;l<Hist[Hist.length-1].numCrds;l++)e.appendChild(t.childNodes[s]);"stockPileDiv"==e.id&&e.lastChild.classList.add("closed"),t.id.startsWith("bay")&&(t.dataset.ord=parseInt(e.lastChild.dataset.ord)-1,e.lastChild.setAttribute("draggable",!0))}Hist.pop(),winCond()||(document.querySelector("h1").style.display="none",document.querySelector("#winBtn").style.display="none")}else alert("You are at the start of the game.")}),stackDivs.forEach(e=>{e.addEventListener("dragover",allowDrop)}),bayDivs.forEach(e=>{e.addEventListener("dragover",allowDrop)}),stackDivs.forEach(e=>{e.addEventListener("drop",drop)}),bayDivs.forEach(e=>{e.addEventListener("drop",drop)}),stockPileDiv.addEventListener("click",()=>{const e=document.querySelectorAll(".sel");if(e.forEach(e=>e.classList.remove("sel")),0==stockPileDiv.childNodes.length){const e=openPileDiv.childNodes.length;for(let t=0;t<e;t++)stockPileDiv.appendChild(openPileDiv.lastChild),stockPileDiv.lastChild.classList.add("closed");const t={fromCntr:"openPileDiv",numCrds:e,toCntr:"stockPileDiv",flip:!1};Hist.push(t)}else{openPileDiv.appendChild(stockPileDiv.lastChild),openPileDiv.lastChild.classList.remove("closed");const e={fromCntr:"stockPileDiv",numCrds:1,toCntr:"openPileDiv",flip:!1};Hist.push(e)}}),stackDivs.forEach(e=>{e.addEventListener("click",()=>{const t=document.querySelectorAll(".card.sel");e.childElementCount<1&&t&&"13"===t[0].dataset.ord&&moveCards(t,e)})}),bayDivs.forEach(e=>{e.addEventListener("click",()=>{const t=document.querySelectorAll(".sel");t&&1==t.length&&t[0].dataset.suit==e.dataset.suit&&parseInt(t[0].dataset.ord)==parseInt(e.dataset.ord)+1?(e.dataset.ord=t[0].dataset.ord,moveCards(t,e)):t.forEach(e=>e.classList.remove("sel"))})});