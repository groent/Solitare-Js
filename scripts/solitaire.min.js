function newGame(){cardDivs.forEach(e=>e.parentNode.removeChild(e)),bayDivs.forEach(e=>e.dataset.ord=0),clearCkie("SolHist"),document.querySelector("h1").style.display="none",document.querySelector("#winBtn").style.display="none",Hist=[];let e=shuffle(52),t=new Array(52);for(let l=0;l<52;l++)t[l]={},t[l].container="stockPile",t[l].selected=!1,t[l].value=CARD_VALUES[e[l]%13+1],t[l].suit=CARD_SUITS[Math.floor(e[l]/13)],t[l].colour=SUIT_VALUE_MAP[t[l].suit];let l={cards:[]};l.cards=t,writeCkie("SolDeck",JSON.stringify(l));let s={};for(let e=1;e<8;e++)for(let t=0;t<e;t++)s=l.cards.shift(),s.container=`stack${e}`,createCard(`stack${e}Div`,s),t==e-1&&document.querySelector(`#stack${e}Div`).lastChild.classList.remove("closed");for(let e=0;e<l.cards.length;e++)l.cards[e].colour=SUIT_VALUE_MAP[l.cards[e].suit],createCard("stockPileDiv",l.cards[e]);AddCardHandlers()}async function rldGame(){cardDivs.forEach(e=>e.parentNode.removeChild(e)),bayDivs.forEach(e=>e.dataset.ord=0),document.querySelector("h1").style.display="none",document.querySelector("#winBtn").style.display="none";let e=JSON.parse(readCkie("SolDeck"));if(null===e)return e=[],alert("No previous game stored."),!1;let t={};for(let l=1;l<8;l++)for(let s=0;s<l;s++)t=e.cards.shift(),t.container=`stack${l}`,createCard(`stack${l}Div`,t),s==l-1&&document.querySelector(`#stack${l}Div`).lastChild.classList.remove("closed");for(let t=0;t<e.cards.length;t++)createCard("stockPileDiv",e.cards[t]);if(AddCardHandlers(),Hist=JSON.parse(readCkie("SolHist")),null!=Hist){console.log("reload game:"+Hist.length);let e=Hist.length;for(let t=0;t<e;t++){let e=document.querySelector("#"+Hist[t].fromCntr).childElementCount+1-Hist[t].numCrds;document.querySelectorAll(".sel").forEach(e=>e.classList.remove("sel")),"stockPileDiv"==Hist[t].fromCntr?document.querySelector("#"+Hist[t].fromCntr).click():"openPileDiv"==Hist[t].fromCntr?(document.querySelector("#"+Hist[t].fromCntr).lastChild.click(),await sleep(200)):(document.querySelector("#"+Hist[t].fromCntr).childNodes[e].click(),await sleep(200)),document.querySelector("#"+Hist[t].toCntr).childElementCount>0?document.querySelector("#"+Hist[t].toCntr).lastChild.click():document.querySelector("#"+Hist[t].toCntr).click()}}Hist=JSON.parse(readCkie("SolHist")),null==Hist&&(Hist=[],console.log("Hist = [], after reload")),console.log("reload successful; history length:"+Hist.length)}function AddCardHandlers(){cardDivs=document.querySelectorAll(".card"),cardDivs.forEach(e=>{e.addEventListener("dragstart",dragStart)}),cardDivs.forEach(e=>{e.addEventListener("dragover",allowDrop)}),cardDivs.forEach(e=>{e.addEventListener("drop",drop)}),cardDivs.forEach(e=>{e.addEventListener("click",()=>{const t=document.querySelectorAll(".sel");e.classList.contains("closed")||e.parentNode.classList.contains("bay")||(e.classList.contains("sel")?t.forEach(e=>e.classList.remove("sel")):t&&0==t.length?(e.classList.add("sel"),selSibsBelow(e),Coords.top=Math.round(e.getBoundingClientRect().top),Coords.left=Math.round(e.getBoundingClientRect().left)):"openPileDiv"!=e.parentNode.id&&t[0].dataset.colour!=e.dataset.colour&&parseInt(t[0].dataset.ord)==parseInt(e.dataset.ord)-1?moveCards(t,e.parentNode):t.forEach(e=>e.classList.remove("sel")))})}),cardDivs.forEach(e=>{e.addEventListener("dblclick",()=>{bayDivs.forEach(t=>{if(e.dataset.suit==t.dataset.suit&&parseInt(e.dataset.ord)==parseInt(t.dataset.ord)+1){t.dataset.ord=e.dataset.ord,e.classList.add("sel");const l=[];l.push(e),moveCards(l,t),t.lastChild.setAttribute("draggable",!1)}})})})}function createCard(e,t){let l=document.querySelector("#"+e),s=document.createElement("div");s.classList.add("card",t.colour,"closed"),s.innerHTML=`${t.value}<br />${t.suit}<span>${t.value}<br />${t.suit}</span>`,s.dataset.value=`${t.suit}${t.value}`,s.dataset.suit=t.suit,s.dataset.colour=t.colour,s.dataset.ord=CARD_VALUE_MAP[t.value],s.setAttribute("draggable",!0),l.appendChild(s)}function moveCards(e,t){const l=e[0].parentNode.querySelectorAll(".card:not(.sel)");let s=!1;if(l&&l.length>0){let e=l[l.length-1];s=e.classList.contains("closed"),e.classList.remove("closed")}let r=new Move(e,t.id,s);Hist.push(r);let o=0,a=0;e.forEach(e=>{t.appendChild(e),e.classList.remove("sel"),o=e.getBoundingClientRect().left-Coords.left,a=e.getBoundingClientRect().top-Coords.top,e.classList.add("anim"),e.style.left=-o+"px",e.style.top=-a+"px",e.style.cssText+=`transition: transform 0.5s ease; transform: translate(${o}px, ${a}px);`,Player.play(),setTimeout(()=>{e.style.cssText="",e.classList.remove("anim")},[500])}),winCond()&&"block"!=document.querySelector("h1").style.display&&(document.querySelector("h1").style.display="block",document.querySelector("#winBtn").style.display="block",window.scrollTo(0,0))}function winCond(){let e=0;return stackDivs.forEach(t=>{t.childElementCount>0&&(selSibsBelow(t.querySelectorAll(".card")[0]),e+=document.querySelectorAll(".closed").length,t.querySelectorAll(".card").forEach(e=>e.classList.remove("sel")))}),!e}function selSibsBelow(e){const t=e.parentNode.querySelectorAll(".card:not(.closed)");for(let e=0;e<t.length;e++)if(t[e].classList.contains("sel")){for(let l=e;l<t.length;l++)t[l].classList.add("sel");break}}function Move(e,t,l){this.fromCntr=e[0].parentNode.id,this.numCrds=e.length,this.toCntr=t,this.flip=l}async function winSequence(e){let t=1,l=0,s=.5,r=2*Math.floor(3*Math.random())+2,o=r,a=1,i=e=>.5*e*e,n=Math.floor(50*Math.random())-30,c=-i(n);Dir*=-1;const d=e.parentNode.getBoundingClientRect().right,u=window.innerWidth-e.parentNode.getBoundingClientRect().right,m=window.innerHeight-e.parentNode.getBoundingClientRect().bottom;for(var h=function(t,l){return new Promise(function(a,n){const d=e.cloneNode(!0);d.classList.add("anim"),d.style.zIndex=Zndx,e.parentNode.appendChild(d),s=i(l)+c,o=r*t,d.style.top=s+"px",d.style.left=Dir*o+"px",a(o,s)})};s<m&&(Dir<0&&o<d||Dir>0&&o<u);){for(l=n;s<m&&(Dir<0&&o<d||Dir>0&&o<u);)h(t,l).then(await sleep(3)),t++,l++;c+=.1*s,a=parseInt(.9*(l-1)),c=s-.5*a*a;for(let e=a;e>-n;e--)h(t,e).then(await sleep(3)),t++}Zndx++}function allowDrop(e){e.preventDefault()}function dragStart(e){cardDivs.forEach(e=>e.classList.remove("sel")),e.target.classList.add("sel"),e.target.parentNode.classList.contains("stack")&&selSibsBelow(e.target)}function drop(e){e.preventDefault(),e.target.click(),cardDivs.forEach(e=>e.classList.remove("sel"))}import{readCkie,writeCkie,clearCkie,sleep,shuffle}from"./utils.min.js";const stockPileDiv=document.querySelector("#stockPileDiv"),openPileDiv=document.querySelector("#openPileDiv"),stackDivs=document.querySelectorAll(".stack"),bayDivs=document.querySelectorAll(".bay"),CARD_VALUE_MAP={0:0,A:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,J:11,Q:12,K:13},CARD_VALUES=["0","A","2","3","4","5","6","7","8","9","10","J","Q","K"],CARD_SUITS=["♠","♥","♦","♣"],SUIT_VALUE_MAP={"♠":"black","♣":"black","♥":"red","♦":"red"};var Hist=[],cardDivs=[],Coords={top:0,left:0};const Player=document.createElement("audio");Player.src="./assets/flip.mp3",Player.load();var Dir=1,Zndx=1;document.querySelector("#winBtn").addEventListener("click",async function(){document.querySelectorAll("button").forEach(e=>e.disabled=!0),document.querySelector("#muteBtn").disabled=!1,document.querySelectorAll(".card.anim").forEach(e=>e.remove());let e=document.querySelectorAll("#openPileDiv .card, .container.stack .card"),t=new MouseEvent("dblclick",{view:window,bubbles:!1,cancelable:!0}),l=e.length;for(let s=0;s<14;s++)for(let r=0;r<l;r++)e[r].dataset.ord==s&&(e[r].dispatchEvent(t),await sleep(200));await sleep(500),e.forEach(e=>{e.style.cssText="",e.classList.remove("anim")}),Player.src="./assets/shuffle.mp3",Player.load(),e=document.querySelectorAll("#bay♠Div .card:not(.anim), #bay♦Div .card:not(.anim)");let s=shuffle(e.length),r=e.length<6?e.length:6;for(let t=0;t<r;t++)Player.play(),await winSequence(e[s[t]]);e=document.querySelectorAll("#bay♥Div .card:not(.anim), #bay♣Div .card:not(.anim)"),s=shuffle(e.length),r=e.length<6?e.length:6;for(let t=0;t<r;t++)Player.play(),await winSequence(e[s[t]]);Player.pause(),Player.src="./assets/flip.mp3",Player.load(),document.querySelectorAll(".anim").forEach(e=>e.classList.add("turn")),document.querySelectorAll("button").forEach(e=>e.disabled=!1)}),document.querySelector("#newBtn").addEventListener("click",function(){document.querySelectorAll(".card.anim").forEach(e=>e.remove()),newGame()}),document.querySelector("#rldBtn").addEventListener("click",async function(){document.querySelectorAll("button").forEach(e=>e.disabled=!0),document.querySelector("#muteBtn").disabled=!1,document.querySelectorAll(".card.anim").forEach(e=>e.remove()),await rldGame(),document.querySelectorAll("button").forEach(e=>e.disabled=!1)}),document.querySelector("#sveBtn").addEventListener("click",function(){document.querySelectorAll(".card.anim").forEach(e=>e.remove()),console.log("history length:"+Hist.length),0==Hist.length?alert("Cannot save any progress. Try reloading game first."):writeCkie("SolHist",JSON.stringify(Hist))}),document.querySelector("#undoBtn").addEventListener("click",function(){if(document.querySelectorAll(".card.anim").forEach(e=>e.remove()),Hist&&Hist.length>0){const e=document.querySelector("#"+Hist[Hist.length-1].fromCntr),t=document.querySelector("#"+Hist[Hist.length-1].toCntr),l=t.childNodes.length-Hist[Hist.length-1].numCrds;if(Hist[Hist.length-1].flip&&e.lastChild.classList.add("closed"),"stockPileDiv"==t.id)for(let l=0;l<Hist[Hist.length-1].numCrds;l++)e.appendChild(t.lastChild),e.lastChild.classList.remove("closed");else{for(let s=0;s<Hist[Hist.length-1].numCrds;s++)e.appendChild(t.childNodes[l]);"stockPileDiv"==e.id&&e.lastChild.classList.add("closed"),t.id.startsWith("bay")&&(t.dataset.ord=parseInt(e.lastChild.dataset.ord)-1,e.lastChild.setAttribute("draggable",!0))}Hist.pop(),winCond()||(document.querySelector("h1").style.display="none",document.querySelector("#winBtn").style.display="none")}else alert("You are at the start of the game.")}),document.querySelector("#muteBtn").addEventListener("click",function(){Player.muted=!Player.muted,this.classList.contains("mute")?(this.classList.remove("mute"),this.offsetParent,this.classList.add("unmute")):(this.classList.remove("unmute"),this.offsetParent,this.classList.add("mute")),Player.play()}),stackDivs.forEach(e=>{e.addEventListener("dragover",allowDrop)}),bayDivs.forEach(e=>{e.addEventListener("dragover",allowDrop)}),stackDivs.forEach(e=>{e.addEventListener("drop",drop)}),bayDivs.forEach(e=>{e.addEventListener("drop",drop)}),stockPileDiv.addEventListener("click",()=>{const e=document.querySelectorAll(".sel");if(e.forEach(e=>e.classList.remove("sel")),0==stockPileDiv.childNodes.length){const e=openPileDiv.childNodes.length;for(let t=0;t<e;t++)stockPileDiv.appendChild(openPileDiv.lastChild),stockPileDiv.lastChild.classList.add("closed");const t={fromCntr:"openPileDiv",numCrds:e,toCntr:"stockPileDiv",flip:!1};Hist.push(t)}else{openPileDiv.appendChild(stockPileDiv.lastChild),openPileDiv.lastChild.classList.remove("closed");const e={fromCntr:"stockPileDiv",numCrds:1,toCntr:"openPileDiv",flip:!1};Hist.push(e)}}),stackDivs.forEach(e=>{e.addEventListener("click",()=>{const t=document.querySelectorAll(".card.sel");e.childElementCount<1&&t&&"13"===t[0].dataset.ord&&moveCards(t,e)})}),bayDivs.forEach(e=>{e.addEventListener("click",()=>{const t=document.querySelectorAll(".sel");t&&1==t.length&&t[0].dataset.suit==e.dataset.suit&&parseInt(t[0].dataset.ord)==parseInt(e.dataset.ord)+1?(e.dataset.ord=t[0].dataset.ord,moveCards(t,e)):t.forEach(e=>e.classList.remove("sel"))})});